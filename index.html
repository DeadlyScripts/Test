<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Paste â†’ Pastefy.app (Fixed!)</title>
    <meta name="description" content="Reliable paste code + image thumbnail to pastefy.app"/>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f0f1a;
            color: #e0e0ff;
            min-height: 100vh;
            padding: 2rem;
            background-image: 
                radial-gradient(circle at 25% 15%, rgba(100,100,255,0.08) 0%, transparent 25%),
                radial-gradient(circle at 75% 85%, rgba(180,100,255,0.06) 0%, transparent 35%);
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 {
            font-size: 2.6rem;
            text-align: center;
            margin-bottom: 0.4rem;
            background: linear-gradient(90deg, #10b981, #7dd3fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { 
            color: #94a3b8; 
            text-align: center; 
            margin-bottom: 2rem; 
            font-size: 1.1rem;
            background: rgba(16,185,129,0.1);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        
        .editor-wrapper {
            border-radius: 12px;
            overflow: hidden;
            background: #1e1e38;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6);
            margin-bottom: 1rem;
        }
        #codeInput {
            width: 100%;
            min-height: 320px;
            padding: 1.5rem;
            background: #111827;
            color: #e0e0ff;
            font-family: 'Consolas', monospace;
            font-size: 15px;
            line-height: 1.45;
            border: none;
            resize: vertical;
            outline: none;
        }
        
        .upload-area {
            padding: 1.2rem 1.5rem;
            background: #172033;
            border-top: 1px solid #2d3748;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        .upload-area label {
            background: #10b981;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .upload-area label:hover { background: #059669; transform: translateY(-1px); }
        #thumbnailPreview {
            max-height: 120px;
            max-width: 180px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid #10b981;
            display: none;
        }
        #fileName { color: #94a3b8; font-size: 0.95rem; flex: 1; }
        
        .controls {
            padding: 1rem 1.5rem;
            background: #172033;
            border-top: 1px solid #2d3748;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: linear-gradient(90deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(16,185,129,0.45);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        #status { 
            color: #94a3b8; 
            font-size: 0.95rem; 
            flex: 1;
            font-family: monospace;
            min-height: 1.4em;
        }
        .success { color: #10b981 !important; }
        .error { color: #f87171 !important; }
        .loading { color: #7dd3fc !important; }
        
        footer {
            margin-top: 3rem;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }
        a { color: #a78bfa; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>âœ… Pastefy Quick (Fixed)</h1>
    <p class="subtitle">No account needed â€¢ Upload image â†’ paste code â†’ instant pastefy.app link</p>

    <div class="editor-wrapper">
        <textarea 
            id="codeInput" 
            placeholder="Paste your code/snippet/text here...&#10;&#10;ðŸ’¡ Image auto-becomes thumbnail/preview on top&#10;ðŸ’¡ Ctrl+Enter to create paste"
            spellcheck="false"
            autofocus
        ></textarea>

        <div class="upload-area">
            <label for="thumbnailInput">ðŸ“¸ Add Thumbnail Image (optional)</label>
            <input type="file" id="thumbnailInput" accept="image/*" hidden>
            <img id="thumbnailPreview" alt="Preview"/>
            <span id="fileName">No image</span>
        </div>

        <div class="controls">
            <button id="createBtn">ðŸš€ Create Pastefy Link</button>
            <span id="status">Ready! (uses public file upload API)</span>
        </div>
    </div>

    <footer>
        Fixed: Uses <strong>/api/v1/pastes</strong> (public) â€¢ 
        <a href="https://pastefy.app" target="_blank">pastefy.app</a> â€¢ 
        <a href="https://docs.pastefy.app/" target="_blank">docs</a>
    </footer>
</div>

<script>
const textarea = document.getElementById('codeInput');
const fileInput = document.getElementById('thumbnailInput');
const preview = document.getElementById('thumbnailPreview');
const fileNameEl = document.getElementById('fileName');
const btn = document.getElementById('createBtn');
const status = document.getElementById('status');

let selectedImageBase64 = null;
let selectedFileName = null;

fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        fileNameEl.textContent = "Select an image";
        preview.style.display = 'none';
        return;
    }

    selectedFileName = file.name;
    fileNameEl.textContent = `Image: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`;

    try {
        selectedImageBase64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
        preview.src = selectedImageBase64;
        preview.style.display = 'block';
    } catch (err) {
        fileNameEl.textContent = "Error loading image";
    }
});

async function createPaste(retries = 2) {
    const code = textarea.value.trim();
    if (!code && !selectedImageBase64) {
        status.textContent = "Add code OR image first";
        return;
    }

    const btn = document.getElementById('createBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Creating...';
    status.textContent = 'Uploading...';
    status.className = 'loading';

    try {
        // Build content: image markdown + code
        let content = code;
        if (selectedImageBase64) {
            content = `![${selectedFileName || 'Preview'}](${selectedImageBase64})\n\n\`\`\`\n${code || ' '}\n\`\`\``;
        }

        // Use FormData for v1 public API
        const formData = new FormData();
        formData.append('f', new Blob([content], { type: 'text/plain;charset=utf-8' }), 
                       selectedFileName || 'paste.txt');

        const response = await fetch('https://pastefy.app/api/v1/pastes', {
            method: 'POST',
            body: formData
        });

        const statusText = `${response.status} ${response.statusText}`;
        
        let data;
        try {
            data = await response.text(); // v1 returns HTML redirect or plain text
        } catch {}

        if (!response.ok) {
            throw new Error(`${statusText}: ${data?.substring(0, 200)}`);
        }

        // v1 returns HTML with redirect URL or direct ID
        let url = null;
        if (data.includes('pastefy.app/')) {
            const match = data.match(/https:\/\/pastefy\.app\/([a-zA-Z0-9]+)/);
            if (match) url = `https://pastefy.app/${match[1]}`;
        }
        
        if (!url && response.url.includes('pastefy.app/')) {
            url = response.url; // Use final redirect URL
        }

        if (!url) throw new Error('No paste URL found in response');

        status.innerHTML = `âœ… <a href="${url}" target="_blank">${url}</a>`;
        status.className = 'success';
        navigator.clipboard.writeText(url);

    } catch (err) {
        console.error(err);
        if (retries > 0) {
            status.textContent = `Temp error, retrying... (${retries})`;
            await new Promise(r => setTimeout(r, 2000));
            return createPaste(retries - 1);
        }
        status.textContent = `âŒ ${err.message}`;
        status.className = 'error';
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        createPaste();
    }
});

btn.addEventListener('click', createPaste);
</script>
</body>
</html>
